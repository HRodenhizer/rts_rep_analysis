---
title: "Prep Polygons"
author: "Heidi Rodenhizer"
date: "`r Sys.Date()`"
output: html_document
---

Calculate PCA coordinates for all polygons

# Load Libraries

```{r}
library(terra)
library(tidyterra)
library(sf)
library(viridis)
library(tidyverse)
```


# Load Data

```{r}
arts = st_read('../ARTS/ARTS_main_dataset/v.0.0.5-alpha/ARTS_main_dataset.geojson')
```

```{r}
pca = rast('./pca/pca.tif')
```


# Calculate Principal Components by Polygon

```{r}
pc_values = zonal(
  pca, 
  vect(arts),
  fun = 'mean',
  na.rm = TRUE
  )

pc_buffer_values = zonal(
  pca, 
  vect(
    arts |>
      st_buffer(1000)
         ),
  fun = 'mean',
  na.rm = TRUE,
  touches = TRUE
  )
```

```{r}
arts_pc = arts |>
  st_drop_geometry() |>
  cbind(pc_values) |>
  cbind(
    pc_buffer_values |>
      rename_with(~ paste0(.x, '_buffer'))
  ) |>
  pivot_longer(cols = PC1:PC30_buffer) |>
  mutate(type = case_when(str_detect(name, 'buffer') ~ 'buffer',
                          TRUE ~ 'normal'),
         variable = str_extract(name, 'PC\\d+')) |>
  select(-name) |>
  pivot_wider(
    names_from = 'type',
    values_from = 'value'
  ) |>
  mutate(normal = case_when(is.na(normal) ~ buffer,
                            TRUE ~ normal)) |>
  select(-buffer) |>
  pivot_wider(names_from = 'variable',
              values_from = 'normal') |>
  full_join(arts |>
              select(CentroidLat, CentroidLon),
            by = c('CentroidLat', 'CentroidLon')) |>
  st_as_sf()

arts_pc |>
  st_drop_geometry() |>
  filter(is.na(PC1)) |>
  summarise(n())
```

```{r}
# st_write(arts_pc,
#          './pca/arts_pc.geojson')
```

```{r}
na_data = arts_pc |> 
  filter(is.na(PC1))

for (idx in 1:nrow(na_data)) {
  
  data = na_data |>
    slice(idx)
  
  pcdata = crop(
    pca |>
      subset('PC1'),
    data |>
      st_buffer(dist = 5000) |>
      st_bbox()
  )
  
  print(ggplot() +
    geom_spatraster(data = pcdata) +
    geom_sf(data = data) +
      geom_sf(data = data |>
                st_buffer(dist = 1000),
              color = 'red',
              fill = 'transparent') +
    scale_fill_viridis(na.value = 'transparent'))
}


```

