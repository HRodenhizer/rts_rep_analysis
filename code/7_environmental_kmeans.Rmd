---
title: "Environmental K Means"
author: "Heidi Rodenhizer"
date: "`r Sys.Date()`"
output: html_document
---

# Load Libraries

```{r}
library(terra)
library(tidyterra)
library(sf)
library(viridis)
library(tidyverse)
```

```{r}
theme_set(theme_bw())
```

# Load Input Data

```{r}
rts_rep_rescale = rast('./input_data/rts_rep_input_data_rescale_3413.tif')
```

```{r}
# Careful! This required about 52 Gb of memory during the conversion.
rts_rep_rescale_df = rts_rep_rescale |>
  as.data.frame(xy = TRUE, cell = TRUE, na.rm = TRUE)

# Make sure to "Free unused R memory" after running
gc()
```

# K-Means Clustering

```{r}
set.seed(123)
km20 = kmeans(
  rts_rep_rescale_df |>
    select(-c('cell', 'x', 'y')),
  20,
  iter.max = 500,
  nstart = 10,
  algorithm = 'Lloyd'
)
```

```{r}
# saveRDS(km20,
#         './kmeans/kmeans.Rdata')
km20 = readRDS('./kmeans/kmeans.Rdata')
```

```{r}
km20_rast = rts_rep_rescale[[1]]

km20_rast[rts_rep_rescale_df$cell] = km20$cluster
names(km20_rast) = c('kmeans')
# writeRaster(km20_rast,
#             './kmeans/km20.tiff')
```

```{r}
ggplot() +
  geom_spatraster(data = km20_rast) +
  scale_fill_viridis(na.value = 'transparent')

# ggsave('./figures/kmeans.jpg',
#        height = 6.5,
#        width = 6.5)
# ggsave('./figures/kmeans.pdf',
#        height = 6.5,
#        width = 6.5)
```

