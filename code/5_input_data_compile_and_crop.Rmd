---
title: "5_input_data_compile_and_crop"
author: "Heidi Rodenhizer"
date: "`r Sys.Date()`"
output: html_document
---

# Load Libraries

```{r}
library(terra)
library(tidyterra)
library(sf)
library(lwgeom)
library(viridis)
library(ggthemes)
library(tidyverse)
```

```{r}
theme_set(theme_bw())
```


# Create Template Raster

```{r}
# template = rast(
#   xmin = -3314693.24,
#   xmax = 3314693.24,
#   ymin = -3314693.24,
#   ymax = 3314693.24,
#   crs = 'EPSG:3413',
#   resolution = 1
# )
```


## Load Extent

```{r}
roi = st_read('./input_data/OlefeldtThermokarstMap/study_extent_buff500.shp')

# Transforming the CRS from a polar projection to WGS84 causes
# incorrect polygons where Russia crosses the 180th meridian.
# Remove a polygon extending from -180 to 180 prior to 
# transforming the CRS to solve this problem.
# Order of the points matters for whether this is a polygon of
# infinite thinness (current) or whole globe (not as written)
split_poly = st_sfc(
      st_polygon(list(matrix(c(180, 0, 
                          -180, 0,
                          -180, 90,
                          180, 90,
                          180, 0), 
                        ncol = 2,
                        byrow = TRUE))),
      crs = 'EPSG:4326'
    ) |>
      st_transform(crs = st_crs(roi))

roi = roi |>
  st_cast('POLYGON') |>
  st_difference(split_poly) |>
  st_transform('EPSG:4326')
```

```{r}
ggplot(roi) +
  geom_sf()
```


# TerraClimate

```{r}
terraclimate = rast('./input_data/TerraClimate/TerraClimateCompiled.tif') |>
  crop(roi) |>
  mask(roi)
```

```{r}
map(
  names(terraclimate),
  ~ ggplot() +
  geom_spatraster(
    data = terraclimate |>
         subset(.x)
    ) +
  scale_fill_viridis(name = .x,
                     na.value = 'transparent') +
  facet_wrap(~lyr) +
  coord_sf(crs = 3413,
           expand = FALSE)
)
```


# Copernicus Topography

```{r}
coptopo = rast('./input_data/Copernicus_DEM/CopernicusDEMCompiled.tif') |>
  crop(roi) |>
  mask(roi)
```

```{r}
map(
  names(coptopo),
  ~ ggplot() +
  geom_spatraster(
    data = coptopo |>
         subset(.x)
    ) +
  scale_fill_viridis(name = .x,
                     na.value = 'transparent') +
  facet_wrap(~lyr) +
  coord_sf(crs = 3413,
           expand = FALSE)
)

```


# NIEER Permafrost (Ran et al. 2022)

```{r}
files = list.files(
  './input_data/NIEERPermafrost/NIEER_permafrost_dataset_released', 
  full.names = TRUE,
  pattern = 'tif$'
)

nieer = files |>
  map(~rast(.x)) |>
  rast() |>
  crop(roi) |>
  mask(roi) |>
  project(terraclimate)
```

```{r}
map(
  names(nieer),
  ~ ggplot() +
  geom_spatraster(
    data = nieer |>
         subset(.x)
    ) +
  scale_fill_viridis(name = .x,
                     na.value = 'transparent') +
  facet_wrap(~lyr) +
  coord_sf(crs = 3413,
           expand = FALSE)
)

```


# Yedoma

```{r}
yedomadomain = st_read('./input_data/IRYP_v2_yedoma/IRYP_v2_yedoma_domain_Shapefile/IRYP_v2_yedoma_domain.shp') |>
  st_transform(st_crs(split_poly)) |>
  st_difference(split_poly) |>
  st_transform(4326) |>
  rasterize(terraclimate)

yedomaconf = st_read('./input_data/IRYP_v2_yedoma/IRYP_v2_yedoma_confidence_Shapefile/IRYP_v2_yedoma_confidence.shp') |>
  st_make_valid() |>
  st_transform(st_crs(split_poly)) |>
  st_difference(split_poly) |>
  st_transform(4326) |>
  rasterize(terraclimate, field = 'confidence')
 

yedoma = c(
    yedomadomain,
    yedomaconf
  )
names(yedoma) <- c('yedomadomain', 'yedomaconf')
```

```{r}
ggplot() +
  geom_spatraster(
    data = yedoma |>
         subset('yedomadomain')
    ) +
  scale_fill_viridis(name = 'Yedoma\nDomain',
                     na.value = 'transparent') +
  coord_sf(expand = FALSE)

ggplot() +
  geom_spatraster(
    data = yedoma |>
         subset('yedomaconf')
    ) +
  scale_fill_viridis(name = 'Yedoma\nConfidence',
                     na.value = 'transparent',
                     discrete = TRUE)
  coord_sf(expand = FALSE)
```


# Brown Permafrost
Something is still wrong with the coordinate system reprojection...

```{r}
brown = st_read('./input_data/BrownCircumArcticPermafrost/permaice.shp') 
brown = brown |>
  st_difference(split_poly |>
                  st_transform(st_crs(brown))) |>
  st_transform(4326)
```

```{r}
ggplot(brown) +
  geom_sf()
```

