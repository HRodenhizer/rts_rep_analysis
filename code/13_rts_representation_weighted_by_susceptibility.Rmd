---
title: "RTS Representation"
author: "Heidi Rodenhizer"
date: "`r Sys.Date()`"
output: html_document
---

# Load Packages

```{r}
library(terra)
library(tidyterra)
library(sf)
library(viridis)
library(tidyverse)
```

```{r}
theme_set(theme_bw())
```


# Load Data

```{r}
rts_probability = rast('./sdm/gbm_kfold_10_pred_tuned_combined_v.1.0.1.tif')
rts_probability = median(rts_probability[[1:10]]/10)
rts_susceptibility_m = rast('../makopoulou_data/Susceptibility_Map.tif') |>
  project(rts_probability, method = 'near')
euc_dist = rast('./euclidean_distance/polygon_counts_1_2_3_v20.tif')
```

```{r}
world = rnaturalearth::ne_countries(scale = "large", returnclass = "sf")
world = world |>
  st_transform(3413) |>
  st_crop(ext(rts_probability))
```


# Histogram of Euclidean Distance

```{r}
euc_dist_df = euc_dist |>
  subset('dist_2_count') |>
  as.data.frame(xy = TRUE, na.rm = FALSE) |>
  mutate(dist_2_count_rank = percent_rank(dist_2_count)*-1 + 1)
```

```{r}
ggplot(euc_dist_df,
       aes(x = dist_2_count_rank)) +
  geom_histogram()
```


# Weight RTS Representation

```{r}
rts_rep_weighted = (
  euc_dist[['dist_2_count']]/
    as.numeric(
      global(euc_dist[['dist_2_count']], 
             fun = 'max', 
             na.rm = TRUE)
      )*-1 + 1
  )

# # Alternate approach using percentiles
# rts_rep_weighted = euc_dist[['dist_2_count']]
# values(rts_rep_weighted) = euc_dist_df$dist_2_count_rank

rts_rep_weighted = rts_rep_weighted*rts_probability/100

# writeRaster(
#   rts_rep_weighted,
#   './data_gaps/rts_data_gaps.tif'
#   )
```

```{r}
ggplot() +
  geom_sf(data = world) +
  geom_spatraster(data = rts_rep_weighted) +
  scale_fill_viridis(name = 'Need for Data',
                     limits = c(0, 1),
                     na.value = 'transparent') +
  coord_sf(expand = FALSE) +
  ggtitle('RTS Knowledge Gaps Weighted by RTS Susceptibility (Woodwell)')

# ggsave('./figures/rts_knowledge_gaps_woodwell.jpg',
#        height = 6,
#        width = 8)
```

```{r}
rts_rep_weighted_m = (
  euc_dist[['dist_2_count']]/
    as.numeric(
      global(euc_dist[['dist_2_count']], 
             fun = 'max', 
             na.rm = TRUE)
      )*-1 + 1
  )
rts_rep_weighted_m = rts_rep_weighted_m*rts_susceptibility_m/5
```

```{r}
ggplot() +
  geom_sf(data = world) +
  geom_spatraster(data = rts_rep_weighted_m) +
  scale_fill_viridis(name = 'Need for Data',
                     na.value = 'transparent') +
  coord_sf(expand = FALSE) +
  ggtitle('RTS Knowledge Gaps Weighted by RTS Susceptibility (Makopoulou)')

# ggsave('./figures/rts_knowledge_gaps_makopoulou.jpg',
#        height = 6,
#        width = 8)
```